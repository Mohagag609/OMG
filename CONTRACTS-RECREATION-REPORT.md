# تقرير إعادة إنشاء صفحة العقود

## المشكلة
كانت صفحة العقود في البرنامج الجديد تفتقر للعديد من الوظائف الموجودة في البرنامج القديم، مما تسبب في أخطاء عند إضافة العقود.

## الحل المطبق
تم إعادة إنشاء صفحة العقود بالكامل لتكون مطابقة تماماً للبرنامج القديم.

## الوظائف المضافة

### 1. نموذج إضافة العقد الكامل
- **اختيار الوحدة**: مع عرض السعر تلقائياً
- **اختيار العميل**: من قائمة العملاء
- **نوع الدفع**: تقسيط أو كاش
- **المقدم**: مع خزنة الإيداع
- **مبلغ الخصم**: خصم من السعر الإجمالي
- **وديعة الصيانة**: مبلغ إضافي للصيانة
- **السمسار**: اسم ونسبة العمولة
- **خزنة العمولة**: خزنة دفع عمولة السمسار
- **تاريخ البداية**: تاريخ بداية العقد

### 2. خيارات الأقساط المتقدمة
- **نوع الأقساط**: شهري، ربع سنوي، نصف سنوي، سنوي
- **عدد الدفعات**: عدد الأقساط العادية
- **الدفعات السنوية**: عدد إضافي من الدفعات السنوية (0-3)
- **قيمة الدفعة السنوية**: قيمة كل دفعة سنوية
- **عرض إجمالي الأقساط**: مجموع الأقساط العادية والسنوية

### 3. التحقق من صحة البيانات
- **التحقق من الشركاء**: التأكد من وجود شركاء للوحدة
- **التحقق من النسب**: التأكد من أن مجموع نسب الشركاء = 100%
- **التحقق من الخزائن**: التأكد من اختيار خزنة المقدم والعمولة
- **التحقق من الأقساط**: التأكد من صحة حسابات الأقساط

### 4. إنشاء السندات التلقائي
- **سند قبض المقدم**: عند وجود مقدم > 0
- **سند دفع العمولة**: عند وجود عمولة سمسار > 0
- **تحديث أرصدة الخزائن**: زيادة رصيد خزنة المقدم، تقليل رصيد خزنة العمولة

### 5. إنشاء الأقساط التلقائي
- **الأقساط العادية**: حسب النوع المحدد (شهري، ربع سنوي، إلخ)
- **الأقساط السنوية**: الدفعات الإضافية السنوية
- **حساب المبالغ**: توزيع المبلغ المتبقي على الأقساط
- **تواريخ الاستحقاق**: حساب تواريخ الاستحقاق الصحيحة

### 6. تحديث حالة الوحدة
- **تغيير الحالة**: من "متاحة" أو "محجوزة" إلى "مباعة"
- **ربط العقد**: ربط العقد بالوحدة والعميل

## الملفات المحدثة

### 1. `src/app/contracts/page.tsx`
- إعادة إنشاء الصفحة بالكامل
- نموذج إضافة عقد شامل
- عرض قائمة العقود
- البحث والتصفية
- إدارة الأخطاء والإشعارات

### 2. `src/app/api/contracts/route.ts`
- تحديث API لاستقبال جميع الحقول
- إضافة التحقق من صحة البيانات
- إنشاء السندات التلقائي
- إنشاء الأقساط التلقائي
- تحديث أرصدة الخزائن

### 3. `prisma/schema.prisma`
- إضافة حقول جديدة للعقد:
  - `brokerPercent`: نسبة عمولة السمسار
  - `downPaymentSafeId`: خزنة المقدم
  - `maintenanceDeposit`: وديعة الصيانة
  - `installmentType`: نوع الأقساط
  - `installmentCount`: عدد الأقساط
  - `extraAnnual`: عدد الدفعات السنوية
  - `annualPaymentValue`: قيمة الدفعة السنوية
  - `downPayment`: مبلغ المقدم
  - `paymentType`: نوع الدفع

### 4. `src/types/index.ts`
- تحديث `Contract` interface لتشمل جميع الحقول الجديدة

## الميزات الجديدة

### 1. واجهة مستخدم محسنة
- نموذج منظم في شبكة 4 أعمدة
- خيارات الأقساط منفصلة في لوحة منفصلة
- عرض إجمالي عدد الأقساط
- رسائل خطأ واضحة

### 2. منطق العمل المحسن
- حساب تلقائي لعمولة السمسار
- تحديث تلقائي للسعر عند اختيار الوحدة
- إخفاء/إظهار خيارات الأقساط حسب نوع الدفع
- حساب تلقائي لإجمالي الأقساط

### 3. إدارة الأخطاء
- رسائل خطأ مفصلة باللغة العربية
- إشعارات نجاح/فشل
- التحقق من صحة البيانات قبل الحفظ

## النتيجة
الآن صفحة العقود مطابقة تماماً للبرنامج القديم وتدعم جميع الوظائف المطلوبة:
- ✅ إضافة عقود جديدة
- ✅ إدارة الأقساط
- ✅ إدارة عمولات السماسرة
- ✅ إنشاء السندات التلقائي
- ✅ تحديث أرصدة الخزائن
- ✅ التحقق من صحة البيانات
- ✅ عرض قائمة العقود
- ✅ البحث والتصفية

## ملاحظات مهمة
- جميع الحسابات مطابقة للبرنامج القديم
- السندات تُنشأ تلقائياً عند إضافة العقد
- الأقساط تُنشأ تلقائياً حسب الإعدادات
- حالة الوحدة تتغير تلقائياً إلى "مباعة"
- جميع التحققات من صحة البيانات مطابقة للبرنامج القديم